# Prometheus exporter for Nimble SRT

## Описание

### Введение

Prometheus exporter for Nimble SRT (далее — Prometheus exporter) предназначен для сбора метрик медиа-сервера Nimble Streamer, работающего по протоколу SRT, с  последующей их отправкой в мониторинговую систему Prometheus.

> **Примечание**
>
> [SRT (Secure Reliable Transport)](https://github.com/Haivision/srt) — протокол передачи видео- и аудиоданных на основе UDP. Оптимизирован для передачи данных через Интернет с минимальной задержкой.

В состав Prometheus exporter входит комплект дашбордов Grafana для визуализации полученных метрик.

### Архитектура

Prometheus-сервер отправляет http-запрос для получения статистики в Prometheus exporter, который, в свою очередь, отправляет запрос в SRT statistic API.

Диаграмма использования:

![](resources/diagram_1.png)

Диаграмма взаимодействия:

![](resources/diagram_2.png)

### Режимы работы

Prometheus exporter может работать в одном из двух режимов:

- Режим периодического сбора метрик — сборщик статистических данных в Prometheus exporter собирает статистику в течение определенного периода и кеширует данные в памяти. При получении запроса все данные из кеша будут отправлены в Prometheus. Этот режим снижает нагрузку на Prometheus, а также снижает сетевой трафик между Prometheus exporter и Prometheus. Недостаток режима — необходимость выделения динамического объема памяти для кеширования данных.

- Пассивный режим - в этом режиме за вызов SRT statictic API отвечает пользователькое приложение. Данные будут хранится в Prometheus exporter и отправлятся в Prometheus по запросу.

## Развертывание

Основной способ развертывания — в контейнере с помощью манифеста:

```yaml
- name: srt-exporter
image: {{ $.Values.werf.image.exporter }}
command:
- /nimble_exporter
- -auth_salt=590
- -auth_hash=xxxx
ports:
- containerPort: 9017
    name: exporter
    protocol: TCP
resources:
    {{ toYaml $.Values.resources.exporter |  nindent 10 }}
```

где:

- `name` — имя контейнера;
- `image` — образ Docker, содержащий приложение;
- `command` — команды, которые выполняются при запуске контейнера;
- `ports` — порты, которые будут открыты для внешних подключений;
- `resources` — ресурсы, которые выделяются контейнеру.

Для успешного развертывания также требуется настроить Prometheus и другие компоненты инфраструктуры мониторинга в соответствии с потребностями пользователя.
